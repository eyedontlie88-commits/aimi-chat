generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Character {
  id                   String              @id @default(cuid())
  name                 String
  avatarUrl            String
  gender               String
  shortDescription     String
  persona              String
  speakingStyle        String
  boundaries           String
  tags                 String
  provider             String              @default("default")
  modelName            String?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  isDevOnly            Boolean             @default(false)
  phoneAutoUpdate      Boolean             @default(true)
  phoneContentJson     String?
  phoneLastUpdated     DateTime?
  phoneMessageCount    Int                 @default(0)
  phoneUpdateFrequency Int                 @default(20)
  age                  Int?
  memories             Memory[]
  messages             Message[]
  relationshipConfig   RelationshipConfig?
}

model UserProfile {
  id                     String               @id @default("me")
  displayName            String
  nicknameForUser        String
  gender                 String?
  age                    Int?
  occupation             String?
  personalityDescription String?
  likes                  String?
  dislikes               String?
  chatTheme              String?              @default("midnight")
  chatTextTone           String?              @default("auto")
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  chatFont               String?              @default("inter")
  chatFontSize           Int?                 @default(14)
  backgroundColor        String?              @default("#1A1A1A")
  textColor              String?              @default("#F9D47E")
  relationshipConfigs    RelationshipConfig[]
}

model RelationshipConfig {
  id                String      @id @default(cuid())
  characterId       String      @unique
  userId            String
  status            String
  startDate         DateTime?
  specialNotes      String?
  intimacyLevel     Int         @default(0)
  affectionPoints   Int         @default(0)
  stage             String      @default("UNDEFINED")
  lastActiveAt      DateTime    @default(now())
  messageCount      Int         @default(0)
  lastStageChangeAt Int         @default(0)
  trustDebt         Float       @default(0.0)
  emotionalMomentum Float       @default(0.0)
  apologyCount      Int         @default(0)
  lastMessageHash   String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  character         Character   @relation(fields: [characterId], references: [id], onDelete: Cascade)
  userProfile       UserProfile @relation(fields: [userId], references: [id])
}

model Message {
  id               String    @id @default(cuid())
  characterId      String
  role             String
  content          String
  sceneState       String?
  createdAt        DateTime  @default(now())
  replyToMessageId String?
  reactionType     String?
  isDeleted        Boolean   @default(false)
  memories         Memory[]  @relation("MessageMemories")
  character        Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  replyTo          Message?  @relation("MessageReplies", fields: [replyToMessageId], references: [id])
  replies          Message[] @relation("MessageReplies")
}

model Memory {
  id              String    @id @default(cuid())
  characterId     String
  type            String
  content         String
  importanceScore Int       @default(5)
  sourceMessageId String?
  category        String    @default("fact")
  visibility      String    @default("public")
  createdAt       DateTime  @default(now())
  isDeleted       Boolean   @default(false)
  character       Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  sourceMessage   Message?  @relation("MessageMemories", fields: [sourceMessageId], references: [id])

  @@index([characterId, importanceScore])
}
